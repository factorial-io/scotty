on: [push, pull_request]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

name: Continuous integration

jobs:
    check:
        name: Check
        runs-on: ubuntu-latest
        strategy:
            matrix:
                features:
                    - name: "default (gRPC)"
                      flags: ""
                    - name: "HTTP telemetry"
                      flags: "--no-default-features --features telemetry-http"
                    - name: "no telemetry"
                      flags: "--no-default-features"
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: stable
            - name: Check ${{ matrix.features.name }}
              run: cargo check --all-targets ${{ matrix.features.flags }}

    test:
        name: Test Suite
        runs-on: ubuntu-latest
        strategy:
            matrix:
                features:
                    - name: "default (gRPC)"
                      flags: ""
                    - name: "HTTP telemetry"
                      flags: "--no-default-features --features telemetry-http"
                    - name: "no telemetry"
                      flags: "--no-default-features"
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: stable
            - uses: dtolnay/rust-toolchain@stable
            - name: Test ${{ matrix.features.name }}
              run: cargo test --all-targets ${{ matrix.features.flags }}

    fmt:
        name: Rustfmt
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: stable
            - run: rustup component add rustfmt
            - uses: dtolnay/rust-toolchain@stable
            - run: cargo fmt --all -- --check

    clippy:
        name: Clippy
        runs-on: ubuntu-latest
        strategy:
            matrix:
                features:
                    - name: "default (gRPC)"
                      flags: ""
                    - name: "HTTP telemetry"
                      flags: "--no-default-features --features telemetry-http"
                    - name: "no telemetry"
                      flags: "--no-default-features"
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: stable
            - run: rustup component add clippy
            - uses: dtolnay/rust-toolchain@stable
            - name: Clippy ${{ matrix.features.name }}
              run: cargo clippy --all-targets ${{ matrix.features.flags }} -- -D warnings

    frontend:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            # Setup Rust toolchain for TypeScript generation
            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: stable

            # Generate TypeScript types from Rust code
            - name: Generate TypeScript types
              run: cargo run --package scotty-ts-generator

            - uses: oven-sh/setup-bun@v2

            # run any `bun` or `bunx` command
            - name: Install dependencies
              run: bun install
              working-directory: frontend
            - name: Run lint check
              run: bun run lint
              working-directory: frontend
            - name: Run build
              run: bun run build
              working-directory: frontend
