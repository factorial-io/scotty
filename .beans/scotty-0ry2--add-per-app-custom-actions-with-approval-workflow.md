---
# scotty-0ry2
title: Add per-app custom actions with approval workflow
status: todo
type: feature
priority: high
created_at: 2025-12-21T12:44:46Z
updated_at: 2025-12-21T13:34:03Z
parent: scotty-d8n9
---

# Description  Allow users to create custom actions for individual apps via scottyctl, with an optional approval workflow for security. This extends the blueprint action system to support ad-hoc, per-app actions without modifying blueprints.  # Background  Currently, actions are defined at the blueprint level and shared across all apps using that blueprint. This proposal allows:  - Creating app-specific actions via CLI - Multi-line command support - Security through an approval workflow - Audit trail for all action operations  # New Permissions  Extends the permission model from scotty-505a2:  ```rust pub enum Permission {     // ... existing     ActionRead,     // Run safe actions     ActionWrite,    // Run state-modifying actions     ActionManage,   // NEW: Create, list, delete own actions     ActionApprove,  // NEW: Approve/reject pending actions (admin-level) } ```  | Permission | Capabilities | |------------|--------------| | `ActionRead` | Execute actions marked as `action_read` | | `ActionWrite` | Execute actions marked as `action_write` | | `ActionManage` | Create/list/delete actions for apps in user's scope | | `ActionApprove` | Approve/reject pending actions, list all pending |  # CLI Commands  ## Creating Actions  ```bash # From YAML file (recommended for multi-line) scottyctl app:action:create my-app --from-file action.yaml  # Multiple --command flags scottyctl app:action:create my-app \   --name "deploy" \   --description "Run deployment" \   --service cli \   --permission action_write \   --command "drush cr" \   --command "drush updb -y" \   --command "drush cim -y"  # From stdin (heredoc) scottyctl app:action:create my-app \   --name "deploy" \   --service cli \   --commands - <<'EOF' drush cr drush updb -y drush cim -y EOF ```  **action.yaml format**: ```yaml name: deploy description: Run full deployment permission: action_write commands:   cli:     - drush cr     - drush updb -y     - drush cim -y     - drush deploy:hook -y   nginx:     - nginx -s reload ```  ## Managing Actions (ActionManage permission)  ```bash # List actions for an app scottyctl app:action:list my-app  # Output: # NAME       STATUS    PERMISSION    CREATED BY           CREATED AT # deploy     pending   action_write  dev@factorial.io     2025-12-21 12:00 # drush:uli  approved  action_read   admin@factorial.io   2025-12-20 10:00  # Delete own pending action scottyctl app:action:delete my-app deploy ```  ## Approval Workflow (ActionApprove permission)  ```bash # List all pending actions across all apps scottyctl admin:actions:pending  # Output: # APP        NAME      PERMISSION    CREATED BY           COMMANDS # my-app     deploy    action_write  dev@factorial.io     drush cr; drush updb... # other-app  migrate   action_write  other@factorial.io   php artisan migrate  # Show full action details for review scottyctl admin:actions:show my-app deploy  # Approve action scottyctl admin:actions:approve my-app deploy --comment "Looks good"  # Reject action scottyctl admin:actions:reject my-app deploy --comment "curl not allowed"  # Revoke previously approved action scottyctl admin:actions:revoke my-app deploy --comment "No longer needed" ```  # Approval Workflow  ## State Machine  ``` ┌──────────┐    create     ┌─────────┐ │          │──────────────▶│         │ │  (none)  │               │ pending │ │          │               │         │ └──────────┘               └────┬────┘                                 │                  ┌──────────────┼──────────────┐                  │              │              │               approve        reject         expire                  │              │              │                  ▼              ▼              ▼             ┌────────┐    ┌──────────┐   ┌─────────┐             │approved│    │ rejected │   │ expired │             └────────┘    └──────────┘   └─────────┘                  │               revoke                  │                  ▼             ┌────────┐             │revoked │             └────────┘ ```  ## Workflow Example  1. Developer creates action:    ```    $ scottyctl app:action:create my-app --from-file deploy.yaml    → Action 'deploy' created (status: pending)    → Notification sent to #scotty-approvals    ```  2. Admin reviews:    ```    $ scottyctl admin:actions:pending    $ scottyctl admin:actions:show my-app deploy    $ scottyctl admin:actions:approve my-app deploy --comment "LGTM"    → Action status: approved    ```  3. Developer can now run:    ```    $ scottyctl app:action:run my-app deploy    → Executes if user has ActionWrite permission    ```  4. Admin revokes if needed:    ```    $ scottyctl admin:actions:revoke my-app deploy --comment "Security concern"    → Action no longer executable    ```  # Design  ## Data Model  ```rust #[derive(Serialize, Deserialize)] pub enum ActionStatus {     Pending,     Approved,     Rejected,     Revoked,     Expired, }  pub struct CustomAction {     pub name: String,     pub description: String,     pub commands: HashMap<String, Vec<String>>,     pub permission: Permission,  // ActionRead or ActionWrite      // Audit fields     pub created_by: String,     pub created_at: DateTime<Utc>,      // Approval workflow     pub status: ActionStatus,     pub reviewed_by: Option<String>,     pub reviewed_at: Option<DateTime<Utc>>,     pub review_comment: Option<String>,      // Expiration     pub expires_at: Option<DateTime<Utc>>, } ```  ## API Endpoints  ### User Endpoints (ActionManage permission)  | Method | Endpoint | Description | |--------|----------|-------------| | POST | `/api/v1/authenticated/apps/{app}/custom-actions` | Create action | | GET | `/api/v1/authenticated/apps/{app}/custom-actions` | List actions | | DELETE | `/api/v1/authenticated/apps/{app}/custom-actions/{name}` | Delete action |  ### Admin Endpoints (ActionApprove permission)  | Method | Endpoint | Description | |--------|----------|-------------| | GET | `/api/v1/authenticated/admin/actions/pending` | List all pending | | GET | `/api/v1/authenticated/admin/actions/{app}/{name}` | Show details | | POST | `/api/v1/authenticated/admin/actions/{app}/{name}/approve` | Approve | | POST | `/api/v1/authenticated/admin/actions/{app}/{name}/reject` | Reject | | POST | `/api/v1/authenticated/admin/actions/{app}/{name}/revoke` | Revoke |  ## Security Controls  ### Layered Security Model  ``` ┌─────────────────────────────────────────────────────────────┐ │                    Layer 1: Permission                       │ │         Only users with ActionManage can create              │ └─────────────────────────────────────────────────────────────┘                               │                               ▼ ┌─────────────────────────────────────────────────────────────┐ │                  Layer 2: Approval Workflow                  │ │         Actions require approval before execution            │ └─────────────────────────────────────────────────────────────┘                               │                               ▼ ┌─────────────────────────────────────────────────────────────┐ │                  Layer 3: Rate Limiting                      │ │         Max N action creations per user per hour             │ └─────────────────────────────────────────────────────────────┘                               │                               ▼ ┌─────────────────────────────────────────────────────────────┐ │                   Layer 4: Audit Trail                       │ │      Log all action CRUD with user, IP, timestamp            │ └─────────────────────────────────────────────────────────────┘ ```  > **Note:** Command blocklist (blocking patterns like `curl`, `wget`, etc.) is deferred to a future iteration.  ## Configuration  ```yaml # Server config action_approval:   # Enable custom actions (default: false)   enabled: true    # Require approval (can be disabled for dev environments)   require_approval: true    # Notifications for pending actions   notify_on_pending:     - mattermost:         webhook_url: https://mm.example.com/hooks/xxx         channel: "#scotty-approvals"    # Auto-expire pending actions after N days   pending_ttl_days: 7    # Auto-expire approved actions after N days (0 = never)   approved_ttl_days: 90 ```  ## Role Configuration Example  ```yaml roles:   admin:     permissions: ['*']    lead-developer:     permissions:       - view       - manage       - action_read       - action_write       - action_manage       - action_approve   # Can approve for their scopes    developer:     permissions:       - view       - manage       - action_read       - action_write       - action_manage    # Can create, but needs approval    viewer:     permissions:       - view       - action_read      # Can run safe actions only ```  # Implementation Phases  ## Phase 1: Core Infrastructure - [ ] Add `ActionManage` and `ActionApprove` permissions - [ ] Create `CustomAction` struct with status tracking - [ ] Extend `AppSettings` to store custom actions - [ ] Add CRUD API endpoints for custom actions  ## Phase 2: Approval Workflow - [ ] Implement action status state machine - [ ] Add admin approval endpoints - [ ] Add notification integration for pending actions - [ ] Implement auto-expiration background task  ## Phase 3: CLI Integration - [ ] Add `app:action:create` with multi-line support - [ ] Add `app:action:list` and `app:action:delete` - [ ] Add `admin:actions:pending/show/approve/reject/revoke`  ## Phase 4: Security Hardening - [ ] Add rate limiting for action creation - [ ] Add comprehensive audit logging  ## Future (Deferred) - [ ] Implement command blocklist validation  # Acceptance Criteria  - [ ] Users with `ActionManage` can create actions (pending status) - [ ] Users with `ActionApprove` can approve/reject pending actions - [ ] Only approved actions can be executed - [ ] Multi-line commands supported via file or stdin - [ ] Audit trail captures all action CRUD operations - [ ] Notifications sent for pending actions (if configured) - [ ] Actions auto-expire based on TTL configuration  # Related Files  - Permission enum: `scotty-core/src/authorization/permission.rs` - App settings: `scotty-core/src/settings/app_settings.rs` - Router: `scotty/src/api/router.rs` - Notification service: `scotty/src/notification/`
