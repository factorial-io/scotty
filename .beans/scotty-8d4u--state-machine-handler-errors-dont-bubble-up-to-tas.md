---
# scotty-8d4u
title: State machine handler errors don't bubble up to tasks
status: completed
type: bug
priority: critical
created_at: 2025-12-21T12:44:47Z
updated_at: 2025-12-21T12:44:47Z
---

# Description  If a state_machine_handler errors out, the error does not bubble up to the task, keeping the task running forever.  # Design  ## Root Cause Analysis  ### Issue #1: State Machine spawn() Returns JoinHandle<()> Location: scotty/src/state_machine.rs:92-108  The spawn() method catches errors internally and returns JoinHandle<()>: - Return type is JoinHandle<()>, not JoinHandle<Result<(), E>> - Errors are only logged, not propagated - JoinHandle always completes successfully even when state machine fails  ### Issue #2: Top-Level Integration Discards Handle Location: scotty/src/docker/helper.rs:44  Handle is discarded with underscore prefix, function returns immediately without checking result.  ### Issue #3: Nested State Machines Lose Errors Locations: create_app.rs:44-45, destroy_app.rs:36-37  Nested state machines don't propagate errors to parent state machine.  ## Proposed Solution  ### Change spawn() to Return Result  New signature: JoinHandle<anyhow::Result<()>>  Benefits: - Explicit error propagation - Type system enforces error handling - Panic-safe with proper JoinError handling  ### Implementation Steps  1. Update state_machine.rs spawn():    - Change return type to JoinHandle<anyhow::Result<()>>    - Return result directly instead of catching errors    - Keep error logging for observability  2. Update helper.rs run_sm():    - Handle Ok(Ok(())) - success    - Handle Ok(Err(e)) - error (already marked Failed by error handler)    - Handle Err(join_err) - panic (manually mark task Failed)  3. Update nested state machines in create_app.rs and destroy_app.rs:    - Propagate errors from inner state machines to outer    - Convert panics to errors  ### Safety Net: Task Timeout (Phase 2)  Add timeout monitoring to catch any missed errors.  ### Files to Modify  1. scotty/src/state_machine.rs - Change spawn() signature 2. scotty/src/docker/helper.rs - Add error/panic handling 3. scotty/src/docker/create_app.rs - Update nested SM 4. scotty/src/docker/destroy_app.rs - Update nested SM 5. scotty/src/tasks/manager.rs - Add timeout (Phase 2) 6. Add comprehensive tests  ### Testing Strategy  - Unit tests: handler failure, panic, nested errors - Integration tests: create app with failures, rebuild failures, timeout  # Notes  Implementation complete with refactoring addressing review feedback.  Commits: - ef543365: Core implementation (spawn returns Result) - 21dadba6: Beads metadata - 0c6012a2: Refactoring - extracted shared helper  Key refactoring: - Added Context::complete_task() as single source of truth - TaskCompletionHandler and helper.rs both use shared helper - Ensures WebSocket broadcast always happens - Defensive and idempotent  All 291+ workspace tests passing. Ready for merge.
