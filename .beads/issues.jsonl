{"id":"scotty-1","content_hash":"793a909e871bdd51163b2b24eb09c4abf9175500540aeaa395bf4170c220e51c","title":"Unified Output System - Complete Implementation","description":"Parent epic tracking the unified output system for logs and interactive shell access. Backend is complete, CLI logs working, but some frontend features and CLI shell command remain.","design":"See docs/prds/unified-output-system.md for complete technical specification. Current status: Phase 1-3.7 and Phase 5 complete, Phase 4 partially complete.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-10-25T00:58:21.660841+02:00","updated_at":"2025-10-25T00:58:21.660841+02:00","source_repo":"."}
{"id":"scotty-10","content_hash":"7e080d2c29ded195d9c883537a286c350e5fbf4ba44da75b1a0a7453c4bec9b8","title":"Instrument shell service with metrics","description":"Add metrics recording to ShellService for session counts, durations, errors, and timeouts.","design":"Instrument ShellService:\n- Track shell_sessions_active gauge\n- Increment shell_sessions_total counter\n- Record shell_session_duration histogram\n- Track shell_session_errors and timeouts","acceptance_criteria":"- Session metrics recorded correctly\n- Duration tracking works\n- Timeout cases tracked separately\n- Memory leak tests pass","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-25T01:28:15.964474+02:00","updated_at":"2025-10-26T18:37:15.004569+01:00","closed_at":"2025-10-26T18:37:15.004569+01:00","source_repo":".","dependencies":[{"issue_id":"scotty-10","depends_on_id":"scotty-5","type":"parent-child","created_at":"2025-10-25T01:28:30.18956+02:00","created_by":"daemon"},{"issue_id":"scotty-10","depends_on_id":"scotty-8","type":"blocks","created_at":"2025-10-25T01:28:42.15994+02:00","created_by":"daemon"}]}
{"id":"scotty-11","content_hash":"e4ebc3a5dc52f3558a718c5d39e886cb3cae8edb63ff33251b2675377f5e4876","title":"Instrument WebSocket connections with metrics","description":"Add metrics to WebSocket client management for connection counts, message throughput, and authentication failures.","design":"Instrument WebSocket layer:\n- Track websocket_connections_active\n- Count messages sent/received\n- Track authentication failures\n- Monitor disconnect events","acceptance_criteria":"- Connection lifecycle tracked\n- Message counters increment correctly\n- Auth failure tracking works\n- No overhead on message path","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-25T01:28:16.086525+02:00","updated_at":"2025-10-26T17:38:41.091932+01:00","closed_at":"2025-10-26T17:38:41.091932+01:00","source_repo":".","dependencies":[{"issue_id":"scotty-11","depends_on_id":"scotty-5","type":"parent-child","created_at":"2025-10-25T01:28:30.272345+02:00","created_by":"daemon"},{"issue_id":"scotty-11","depends_on_id":"scotty-8","type":"blocks","created_at":"2025-10-25T01:28:42.23292+02:00","created_by":"daemon"}]}
{"id":"scotty-12","content_hash":"ce45d41e671a58889f747b2e33ae81b26477174b2a5597d27ae85effa386d449","title":"Add observability stack to docker-compose","description":"Create docker-compose.observability.yml with OTel Collector, VictoriaMetrics, and Grafana services. Create OTel Collector configuration file.","design":"Create docker-compose.observability.yml with:\n- otel-collector service (ports 4317/4318)\n- victoriametrics service (port 8428)\n- grafana service (port 3000)\n- Create otel-collector-config.yaml with trace/metrics pipelines\n- Add Traefik labels for ddev.site domains","acceptance_criteria":"- docker-compose up works with observability stack\n- OTel Collector receives metrics on port 4317\n- VictoriaMetrics stores metrics\n- Grafana accessible at grafana.ddev.site\n- No port conflicts with existing services","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-25T01:28:16.207816+02:00","updated_at":"2025-10-25T01:38:25.612801+02:00","closed_at":"2025-10-25T01:38:25.612801+02:00","source_repo":".","dependencies":[{"issue_id":"scotty-12","depends_on_id":"scotty-5","type":"parent-child","created_at":"2025-10-25T01:28:30.352479+02:00","created_by":"daemon"}]}
{"id":"scotty-13","content_hash":"71764863c289dcdf780220924e5508250e60837e9f4641791cdcb6ed3aff0d3a","title":"Create Grafana dashboards for Scotty metrics","description":"Create Grafana dashboard JSON and provisioning config showing unified output system metrics with panels for log streams, shell sessions, WebSocket connections, and tasks.","design":"Create Grafana assets:\n- grafana/provisioning/datasources/datasources.yaml (VictoriaMetrics + Jaeger)\n- grafana/provisioning/dashboards/dashboards.yaml\n- grafana/dashboards/scotty-unified-output.json\n- Panels: active streams, session durations, message rates, error rates","acceptance_criteria":"- Grafana dashboard loads automatically\n- All panels show live data\n- VictoriaMetrics datasource works\n- Dashboard is intuitive and useful\n- Export JSON to git","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-25T01:28:16.355104+02:00","updated_at":"2025-10-25T15:21:28.683425+02:00","closed_at":"2025-10-25T15:21:28.683425+02:00","source_repo":".","dependencies":[{"issue_id":"scotty-13","depends_on_id":"scotty-5","type":"parent-child","created_at":"2025-10-25T01:28:30.434812+02:00","created_by":"daemon"},{"issue_id":"scotty-13","depends_on_id":"scotty-12","type":"blocks","created_at":"2025-10-25T01:28:42.307778+02:00","created_by":"daemon"}]}
{"id":"scotty-14","content_hash":"7b76b36d0a00fa22a04c81a6e317f4c5086057c5b3a89826d6bb7f0e623417c3","title":"Document metrics and observability setup","description":"Write documentation for setting up and using the observability stack, including metrics available, dashboard usage, and troubleshooting.","design":"Documentation:\n- README section on observability\n- docs/observability/setup.md - How to run the stack\n- docs/observability/metrics.md - Available metrics reference\n- docs/observability/dashboards.md - Dashboard guide\n- Troubleshooting common issues","acceptance_criteria":"- Setup instructions are clear and complete\n- Metrics reference documents all instruments\n- Dashboard guide has screenshots\n- Troubleshooting covers common issues\n- Updates to main README.md","status":"closed","priority":3,"issue_type":"task","created_at":"2025-10-25T01:28:16.527864+02:00","updated_at":"2025-10-26T18:43:52.600539+01:00","closed_at":"2025-10-26T18:43:52.600539+01:00","source_repo":".","dependencies":[{"issue_id":"scotty-14","depends_on_id":"scotty-5","type":"parent-child","created_at":"2025-10-25T01:28:30.517999+02:00","created_by":"daemon"}]}
{"id":"scotty-15","content_hash":"88c57c99a00b06160eb6cd61b28a20cb8f447ba5a08cabab646a14f991d33b84","title":"Upgrade OpenTelemetry dependencies to latest versions","description":"Upgrade opentelemetry, opentelemetry_sdk, and opentelemetry-otlp crates to their latest stable versions to get bug fixes, performance improvements, and new features.","design":"Check current versions in Cargo.toml workspace dependencies:\n- opentelemetry = \"0.28.0\"\n- opentelemetry_sdk = \"0.28\"\n- opentelemetry-otlp = \"0.28.0\"\n\nResearch latest versions on crates.io and upgrade incrementally. Update any API changes in:\n- scotty/src/metrics/init.rs\n- scotty/src/metrics/instruments.rs\n- scotty/src/init_telemetry.rs\n\nTest that traces and metrics still export correctly after upgrade.","acceptance_criteria":"- All opentelemetry crates upgraded to latest stable versions\n- Cargo.toml updated with new versions\n- Code compiles without errors\n- Metrics initialization works\n- Traces export successfully\n- No breaking changes in existing functionality","notes":"Successfully upgraded OpenTelemetry from 0.28 to 0.31 (latest stable version):\n\nUpgraded crates:\n- opentelemetry: 0.28.0 → 0.31.0\n- opentelemetry_sdk: 0.28 → 0.31\n- opentelemetry-otlp: 0.28.0 → 0.31.0 (added grpc-tonic feature)\n- tracing-opentelemetry: 0.29 → 0.32\n- axum-tracing-opentelemetry: 0.26.0 → 0.32.1\n- init-tracing-opentelemetry: 0.27.0 → 0.32.1\n\nAPI changes handled:\n- Fixed TraceError import (moved to opentelemetry_sdk::trace)\n- Updated init_tracerprovider imports (now in otlp::traces module)\n- Fixed TracingConfig import (moved to config module)\n- Added error conversion for init_tracerprovider\n- Fixed build_layer() result handling\n\nRemoved axum-otel-metrics due to version conflict (required 0.30 while ecosystem moved to 0.31). Implemented custom HTTP metrics middleware instead.\n\nImplementation notes:\n- Created scotty/src/metrics/http.rs with custom middleware\n- Tracks http_requests_total, http_request_duration, http_requests_active\n- Fixed telemetry_enabled flag to check for both 'traces' and 'metrics'\n- All metrics exporting correctly to VictoriaMetrics\n- Grafana dashboard updated with correct metric names\n\nCommits: bb28b5cd, 075c755b, 8e297537","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-25T01:51:52.305855+02:00","updated_at":"2025-10-25T18:54:58.935792+02:00","closed_at":"2025-10-25T18:54:58.935792+02:00","source_repo":".","dependencies":[{"issue_id":"scotty-15","depends_on_id":"scotty-8","type":"blocks","created_at":"2025-10-25T01:51:52.306614+02:00","created_by":"daemon"}]}
{"id":"scotty-16","content_hash":"4e740cdaba92919364b8f794b348b3290ecefb542d101944286a38c2c1f33280","title":"Instrument task output streaming with metrics","description":"Add metrics recording to TaskOutputStreamingService for task counts, durations, errors, and output volume.","design":"Instrument TaskOutputStreamingService similar to LogStreamingService:\n- Track tasks_active gauge (current running tasks)\n- Track tasks_total counter (cumulative task count)\n- Add task_output_lines counter (throughput tracking)\n- Add task_errors counter (error tracking)\n- Consider task_duration histogram if tasks have clear lifecycle\n\nLocation: scotty/src/tasks/output_streaming.rs\nPattern: Use metrics::get_metrics() to access global metrics instance","acceptance_criteria":"- Metrics recorded at task start/end\n- Output lines counted\n- Error cases tracked\n- No performance degradation\n- Code compiles and tests pass","status":"closed","priority":3,"issue_type":"task","created_at":"2025-10-25T02:29:59.988921+02:00","updated_at":"2025-10-26T18:10:42.53396+01:00","closed_at":"2025-10-26T18:10:42.53396+01:00","source_repo":".","dependencies":[{"issue_id":"scotty-16","depends_on_id":"scotty-8","type":"blocks","created_at":"2025-10-25T02:29:59.990577+02:00","created_by":"daemon"}]}
{"id":"scotty-17","content_hash":"af55ea84d30e254cbbb2261c8496d383ded3e35d89634d0bd627ef4347d39660","title":"Add memory usage metrics","description":"Track scotty's memory usage (heap allocated, RSS, etc.) to monitor resource consumption and detect memory leaks.","design":"Add memory metrics to ScottyMetrics struct:\n- memory_heap_bytes (Gauge) - heap allocated memory\n- memory_rss_bytes (Gauge) - resident set size\n- Consider using jemalloc or system metrics crate\n\nOptions:\n1. Use `sysinfo` crate for cross-platform process metrics\n2. Use jemalloc stats if using jemalloc allocator\n3. Sample memory every 30s-60s to avoid overhead\n\nLocation: \n- Add metrics to scotty/src/metrics/instruments.rs\n- Add sampling task to scotty/src/main.rs or metrics/mod.rs\n- Record metrics periodically in background task","acceptance_criteria":"- Memory metrics exported to OTLP\n- Metrics update at reasonable interval (30-60s)\n- Minimal performance overhead\n- Works on all platforms (Linux, macOS)\n- Dashboard panel created for memory tracking","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-25T02:30:11.101617+02:00","updated_at":"2025-10-25T02:49:17.419136+02:00","closed_at":"2025-10-25T02:49:17.419136+02:00","source_repo":".","dependencies":[{"issue_id":"scotty-17","depends_on_id":"scotty-8","type":"blocks","created_at":"2025-10-25T02:30:11.102361+02:00","created_by":"daemon"}]}
{"id":"scotty-18","content_hash":"26625f19355185feeea883904d71857af34b14e26fda019f2b3d7a917f31a011","title":"Add Tokio runtime metrics","description":"Track Tokio async runtime statistics like active tasks, worker threads, idle time, and task queue depth to monitor async performance.","design":"Add Tokio runtime metrics to ScottyMetrics:\n- tokio_tasks_active (Gauge) - currently spawned tasks\n- tokio_workers_count (Gauge) - number of worker threads\n- tokio_workers_idle (Gauge) - idle workers\n- tokio_tasks_spawned_total (Counter) - total tasks spawned\n\nImplementation options:\n1. Use tokio-metrics crate (official tokio metrics)\n2. Use tokio::runtime::Handle::metrics() (requires unstable features)\n3. Use tokio-console integration via console-subscriber\n\nRecommended: tokio-metrics crate\n- Add tokio-metrics to Cargo.toml\n- Create background task to sample runtime metrics\n- Record every 10-30s\n\nLocation:\n- Add metrics to scotty/src/metrics/instruments.rs\n- Add tokio metrics sampler in scotty/src/metrics/tokio.rs\n- Spawn sampling task in main.rs after runtime creation","acceptance_criteria":"- Tokio runtime metrics exported to OTLP\n- Metrics show active tasks and worker state\n- Minimal performance overhead\n- Code compiles with stable Rust\n- Dashboard panel created for runtime monitoring","status":"closed","priority":3,"issue_type":"task","created_at":"2025-10-25T02:30:22.11133+02:00","updated_at":"2025-10-25T16:17:30.994921+02:00","closed_at":"2025-10-25T16:17:30.994921+02:00","source_repo":".","dependencies":[{"issue_id":"scotty-18","depends_on_id":"scotty-8","type":"blocks","created_at":"2025-10-25T02:30:22.112175+02:00","created_by":"daemon"}]}
{"id":"scotty-19","content_hash":"0b0c92f1ee343f6cf45af950d84d859c1f90253242c2423b0b1dc76bb7c1a1da","title":"Add TaskManager metrics for task tracking","description":"Instrument TaskManager to track number of tasks, their states (running/finished/failed), durations, and success rates.","design":"Add TaskManager metrics to ScottyMetrics struct:\n- tasks_total (Counter) - Total tasks created\n- tasks_by_state (Gauge) - Current tasks grouped by state labels:\n  * state=\"running\"\n  * state=\"finished\"\n  * state=\"failed\"\n- task_duration_seconds (Histogram) - Task execution time\n- task_failures_total (Counter) - Failed tasks counter\n\nImplementation approach:\n1. Add metrics to scotty/src/metrics/instruments.rs\n2. Instrument scotty/src/tasks/manager.rs:\n   - add_task(): increment tasks_total, update state gauge\n   - set_task_finished(): update state gauges, record duration histogram\n   - Optional: background sampler every 30s to sync gauges with HashMap state\n\nData sources:\n- TaskManager.processes HashMap size = total active tasks\n- TaskDetails.state: Running | Finished | Failed\n- TaskDetails.start_time + finish_time for duration calculation\n- TaskDetails.last_exit_code for success/failure tracking","acceptance_criteria":"- Task metrics exported to OTLP\n- Metrics accurately reflect task states\n- Duration tracking works correctly\n- Failed vs successful tasks distinguishable\n- Dashboard panels created for task monitoring\n- No performance degradation","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-25T02:37:07.454119+02:00","updated_at":"2025-10-25T15:29:19.632177+02:00","closed_at":"2025-10-25T15:29:19.632177+02:00","source_repo":".","dependencies":[{"issue_id":"scotty-19","depends_on_id":"scotty-8","type":"blocks","created_at":"2025-10-25T02:37:07.454889+02:00","created_by":"daemon"}]}
{"id":"scotty-2","content_hash":"1ed00f065aedf21f6e4223688f71dd42245abc363a569c0cbef52a84ddb82913","title":"Implement app:shell CLI command in scottyctl","description":"Add the app:shell command to scottyctl CLI. Backend ShellService is fully implemented and tested, but the CLI command is missing. Need to create scottyctl/src/commands/apps/shell.rs with WebSocket-based terminal integration.","design":"- Create ShellCommand struct in cli.rs\n- Implement WebSocket-based shell handler in commands/apps/shell.rs\n- Add TTY resize handling and raw terminal mode\n- Support interactive input/output with proper escape sequences\n- Reuse AuthenticatedWebSocket pattern from logs command","acceptance_criteria":"- scottyctl app:shell myapp web opens interactive shell\n- Terminal escape sequences work correctly\n- Ctrl+C and Ctrl+D handled properly\n- Session cleanup on disconnect\n- Help text and examples documented","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-10-25T00:58:21.798713+02:00","updated_at":"2025-11-03T14:07:16.855054+01:00","closed_at":"2025-11-03T14:07:16.855054+01:00","source_repo":".","dependencies":[{"issue_id":"scotty-2","depends_on_id":"scotty-1","type":"parent-child","created_at":"2025-10-25T00:58:32.439042+02:00","created_by":"daemon"}]}
{"id":"scotty-20","content_hash":"f22e69f6928fe46c283b38239cfd42f61f8d6b90efcfedafeea1436a7caa6c10","title":"Add AppList metrics for application monitoring","description":"Instrument SharedAppList to track number of apps, their states (stopped/starting/running/etc), services per app, and health check age.","design":"Add AppList metrics to ScottyMetrics struct:\n- apps_total (Gauge) - Total number of managed apps\n- apps_by_status (Gauge) - Apps grouped by status labels:\n  * status=\"stopped\"\n  * status=\"starting\"\n  * status=\"running\"\n  * status=\"creating\"\n  * status=\"destroying\"\n  * status=\"unsupported\"\n- app_services_count (Histogram) - Distribution of services per app\n- app_last_check_age_seconds (Histogram) - Time since last health check\n\nImplementation approach:\n1. Add metrics to scotty/src/metrics/instruments.rs\n2. Instrument scotty-core/src/apps/shared_app_list.rs:\n   - add_app() / remove_app(): update apps_total\n   - Background sampler task (30-60s interval):\n     * Iterate apps HashMap\n     * Count by status\n     * Sample services.len() distribution\n     * Calculate last_checked age\n3. Spawn sampler task in scotty/src/main.rs or via AppState\n\nData sources:\n- SharedAppList.apps HashMap size = total apps\n- AppData.status: Stopped | Starting | Running | Creating | Destroying | Unsupported\n- AppData.services.len() = service count per app\n- AppData.last_checked timestamp for age calculation\n\nNote: Requires access to SharedAppList from metrics, may need to pass via background task or add to AppState.","acceptance_criteria":"- App metrics exported to OTLP\n- Metrics accurately reflect app states\n- Status distribution correct\n- Service count distribution tracked\n- Health check age visible\n- Dashboard panels created for app monitoring\n- Minimal performance overhead from sampling","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-25T02:37:26.668911+02:00","updated_at":"2025-10-26T17:20:02.191752+01:00","closed_at":"2025-10-26T17:20:02.191752+01:00","source_repo":".","dependencies":[{"issue_id":"scotty-20","depends_on_id":"scotty-8","type":"blocks","created_at":"2025-10-25T02:37:26.669776+02:00","created_by":"daemon"}]}
{"id":"scotty-21","content_hash":"58caaae0e5d1a32d43f55d26aa0925421b023587fc6fe5f69d7ab593df8ab245","title":"Add Traefik to observability docker-compose for .ddev.site URLs","description":"The observability stack uses Traefik labels for routing (grafana.ddev.site, jaeger.ddev.site, vm.ddev.site) but requires external Traefik to be running from apps/traefik. This creates a dependency and extra setup step.\n\nAdd Traefik service to observability/docker-compose.yml so the stack works out-of-the-box without requiring apps/traefik to be running.","design":"Options:\n1. Add Traefik service to observability/docker-compose.yml\n   - Include network configuration\n   - Configure dashboard access\n   - Ensure no port conflicts with main Traefik\n\n2. Share network with existing apps/traefik\n   - Create external network\n   - Less duplication but still requires apps/traefik\n\nRecommended: Option 1 - self-contained observability stack\n\nImplementation:\n- Add Traefik service to observability/docker-compose.yml\n- Use different ports than apps/traefik (80/443 vs 8080/8443)\n- Configure proxy network\n- Update README.md to mention this works standalone","acceptance_criteria":"- grafana.ddev.site, jaeger.ddev.site, vm.ddev.site work without apps/traefik running\n- cd observability \u0026\u0026 docker-compose up -d brings up full working stack\n- No port conflicts with apps/traefik\n- Documentation updated","status":"open","priority":3,"issue_type":"task","created_at":"2025-10-25T02:59:32.096433+02:00","updated_at":"2025-10-25T02:59:32.096433+02:00","source_repo":"."}
{"id":"scotty-22","content_hash":"7a9a1a2bd03aa36bebbe17c53dd442c7ff83882943f82fbb09fd35f87dc0336e","title":"Refactor metrics instrumentation to use dedicated helper functions","description":"Review and refactor existing metrics code in log streaming and other services to move metrics recording into dedicated helper functions, keeping business logic clean and separated from instrumentation code.","design":"Pattern established in scotty-19:\n- Create dedicated helper functions like `record_task_added_metrics()` and `record_task_finished_metrics()`\n- Move all `if let Some(m) = metrics::get_metrics()` blocks into these helpers\n- Keep business logic methods focused on their primary responsibility\n\nFiles to review and refactor:\n- scotty/src/docker/services/logs.rs (log streaming metrics)\n- scotty/src/docker/services/shell.rs (shell session metrics - if implemented)\n- Any other services with inline metrics code\n\nBenefits:\n- Cleaner separation of concerns\n- Easier to test business logic without metrics\n- Consistent metrics instrumentation pattern\n- Better code readability","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-10-25T15:28:09.285832+02:00","updated_at":"2025-10-25T16:07:00.885661+02:00","closed_at":"2025-10-25T16:07:00.885661+02:00","source_repo":"."}
{"id":"scotty-23","content_hash":"41486ef15e0a321857e8e6ac02e5f1779e7a706f515ff25b4bc5c87a57b79930","title":"Reduce cloning overhead by wrapping AppData in Arc","description":"AppData is cloned on every access from SharedAppList. Wrapping AppData in Arc would make cloning cheap (just reference count increment) instead of copying all nested structures.","design":"Location: scotty-core/src/apps/shared_app_list.rs:56-58\n\nCurrent code clones entire AppData structure on every get_app() call. AppData contains multiple nested structures (containers, services, settings) making clones expensive.\n\nProposed solution:\n```rust\npub type SharedAppData = Arc\u0026lt;AppData\u0026gt;;\n\npub async fn get_app(\u0026amp;self, app_name: \u0026amp;str) -\u0026gt; Option\u0026lt;SharedAppData\u0026gt; {\n    let t = self.apps.read().await;\n    t.get(app_name).map(Arc::clone)  // Only clones Arc, not data\n}\n```\n\nImpact: Major performance improvement for app data access paths\nEffort: 2-4 hours","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-26T21:21:10.34027+01:00","updated_at":"2025-10-26T21:21:10.34027+01:00","source_repo":".","labels":["performance","refactoring"]}
{"id":"scotty-24","content_hash":"6b42e959791acef094fb25bba3bbd23a1e4addc7e40928dc2d010e2b6e1993d8","title":"Add timeout to Docker command execution","description":"Docker commands currently have no timeout and could hang indefinitely if Docker daemon becomes unresponsive.","design":"Location: scotty/src/docker/docker_compose.rs:88\n\nCurrent code:\n```rust\nlet output = cmd.output()?;  // No timeout\n```\n\nProposed solution:\n```rust\nuse tokio::time::timeout;\n\nlet output = timeout(\n    Duration::from_secs(300),  // 5 minute timeout\n    tokio::process::Command::new(\"docker-compose\")\n        .args(command)\n        .output()\n).await??;\n```\n\nImpact: Prevents indefinite hangs on Docker failures\nEffort: 1-2 hours","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-26T21:21:10.406194+01:00","updated_at":"2025-10-26T21:21:10.406194+01:00","source_repo":".","labels":["docker","stability"]}
{"id":"scotty-25","content_hash":"886cf0f3532746e5e748706859d81554131bc30e72afd57e766f6477ef6e2b4b","title":"Improve authorization error handling in Casbin enforcement","description":"Authorization service silently denies access on Casbin errors using unwrap_or(false), potentially hiding system issues.","design":"Location: scotty/src/services/authorization/service.rs:182\n\nCurrent code:\n```rust\nlet result = enforcer\n    .enforce(vec![user, app, action_str])\n    .unwrap_or(false);\n```\n\nProposed solution:\n```rust\nlet result = enforcer\n    .enforce(vec![user, app, action_str])\n    .map_err(|e| {\n        error!(\"Casbin enforce error: {}\", e);\n        crate::metrics::authorization::record_error();\n    })\n    .unwrap_or(false);\n```\n\nImpact: Better visibility into authorization failures\nEffort: 30 minutes","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-26T21:21:10.471975+01:00","updated_at":"2025-10-26T21:21:10.471975+01:00","source_repo":".","labels":["observability","security"]}
{"id":"scotty-26","content_hash":"9a8b423bdc80bd4b30761d984bdce367672a3843adea1bb69c89ecc64cc25a8f","title":"Fix wildcard dependency for tracing-subscriber","description":"tracing-subscriber uses wildcard version \"*\" which prevents reproducible builds.","design":"Location: Cargo.toml:36\n\nCurrent: `tracing-subscriber = \"*\"`\nReplace with: `tracing-subscriber = \"0.3\"`\n\nImpact: Reproducible builds\nEffort: 5 minutes","status":"closed","priority":1,"issue_type":"chore","assignee":"claude","created_at":"2025-10-26T21:21:10.53848+01:00","updated_at":"2025-10-26T22:00:48.493544+01:00","closed_at":"2025-10-26T22:00:48.493544+01:00","source_repo":".","labels":["dependencies"]}
{"id":"scotty-27","content_hash":"a9b6d5ab1608c74206914645f2f63fac8918a9794f8daad2322994b0df5b49a5","title":"Wrap large configuration structures in Arc","description":"Settings struct contains large nested HashMaps (blueprints, registries) that get cloned unnecessarily. Wrapping them in Arc would reduce clone overhead.","design":"Location: scotty-core/src/settings/apps.rs\n\nSettings contains large, rarely modified structures that are cloned when Settings is cloned.\n\nProposed solution:\n```rust\n#[derive(Clone)]\npub struct Apps {\n    pub root_folder: String,\n    pub blueprints: Arc\u0026lt;HashMap\u0026lt;String, AppBlueprint\u0026gt;\u0026gt;,  // Large, rarely modified\n    // ...\n}\n```\n\nImpact: Reduce Settings clone overhead\nEffort: 1-2 hours","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-26T21:21:10.606337+01:00","updated_at":"2025-10-26T21:21:10.606337+01:00","source_repo":".","labels":["performance","refactoring"]}
{"id":"scotty-28","content_hash":"e93c257861dbe5a7e074eb62efe5824837ebbb3a1eea2a0f948e996cd112e904","title":"Consider DashMap for WebSocket client management","description":"WebSocket client HashMap uses Arc\u0026lt;Mutex\u0026lt;HashMap\u0026gt;\u0026gt; which causes lock contention during broadcasts. DashMap provides lock-free reads.","design":"Location: scotty/src/api/websocket/messaging.rs\n\nCurrent implementation uses mutex-protected HashMap which can cause contention during broadcasts to multiple clients.\n\nProposed solution:\n```rust\nuse dashmap::DashMap;\n\npub struct WebSocketMessenger {\n    clients: Arc\u0026lt;DashMap\u0026lt;Uuid, WebSocketClient\u0026gt;\u0026gt;,\n}\n```\n\nBenefits:\n- Lock-free concurrent reads\n- Automatic sharding for better concurrency\n- Reduced contention during broadcasts\n\nImpact: Reduced lock contention during broadcasts\nEffort: 2-3 hours","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-26T21:21:10.680572+01:00","updated_at":"2025-10-26T21:21:10.680572+01:00","source_repo":".","labels":["performance","websocket"]}
{"id":"scotty-29","content_hash":"ba4c494bff4025165510336ca9cbe81d56de4731f6fa4da73ef13dffde2499b3","title":"Split large authorization service file into submodules","description":"The authorization service.rs file is 754 lines and could be split into more focused submodules for better maintainability.","design":"Location: scotty/src/services/authorization/service.rs (754 lines)\n\nProposed structure:\n- service.rs - Core service and main authorization logic\n- permissions.rs - Permission checking and management\n- scopes.rs - Scope-related operations\n- roles.rs - Role management\n- assignments.rs - Assignment handling\n\nImpact: Better code organization and maintainability\nEffort: 2-4 hours","status":"open","priority":1,"issue_type":"chore","created_at":"2025-10-26T21:21:10.754914+01:00","updated_at":"2025-10-26T21:21:10.754914+01:00","source_repo":".","labels":["maintainability","refactoring"]}
{"id":"scotty-3","content_hash":"de9426db073045cb2371a55190cb027d0d5985c14452b589e4c06cf9dc7ed6a7","title":"Frontend container log viewer UI","description":"Add UI to view container logs in the web frontend. Backend log streaming API is complete with WebSocket support, but frontend has no log viewer component.","design":"- Create log viewer component similar to unified-output.svelte\n- Add WebSocket handlers for LogLineReceived/LogStreamStarted/LogStreamEnded messages\n- Add log viewer page or modal accessible from app detail page\n- Support follow mode, timestamps, line limits\n- Reuse webSocketStore.ts infrastructure","acceptance_criteria":"- Can view historical logs for any service\n- Follow mode for real-time streaming\n- Toggle timestamps on/off\n- Auto-scroll control\n- Copy logs to clipboard\n- Integration from app detail page","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-25T00:58:21.90526+02:00","updated_at":"2025-10-25T01:06:56.395577+02:00","closed_at":"2025-10-25T01:06:56.395577+02:00","source_repo":".","dependencies":[{"issue_id":"scotty-3","depends_on_id":"scotty-1","type":"parent-child","created_at":"2025-10-25T00:58:32.507014+02:00","created_by":"daemon"}]}
{"id":"scotty-30","content_hash":"b19b2e83d0110ae93c2f113f78cf796bf422cf596f1509dab19eb3e6253524f3","title":"Add metrics for clone operations in hot paths","description":"Add tracing/metrics to performance-critical clone operations to identify actual hotspots with real usage data.","design":"Add instrumentation to measure clone operations in:\n- AppData access patterns\n- Settings propagation\n- State machine handler contexts\n\nUse tracing spans with timing information to identify which clones actually impact performance in production.\n\nThis data will help prioritize which clone operations to optimize first.\n\nImpact: Data-driven optimization decisions\nEffort: 2-3 hours","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-26T21:21:10.829701+01:00","updated_at":"2025-10-26T21:21:10.829701+01:00","source_repo":".","labels":["observability","performance"]}
{"id":"scotty-31","content_hash":"eb8d18aa87943a8f5fb5c9cc7e0c94f17dcdc66da9d3976d1bab52f4e59339cc","title":"Refactor test code organization and extract common helpers","description":"Extract common test helpers and utilities into a dedicated test utilities module to reduce duplication across test files.","design":"Current state: Test code has duplicated setup/teardown logic and helper functions across multiple test files.\n\nProposed:\n- Create `scotty/tests/common/mod.rs` for shared test utilities\n- Extract common fixtures (test users, apps, configurations)\n- Create builder patterns for test data\n- Consolidate mock setup functions\n\nImpact: Reduce test code duplication, easier to maintain tests\nEffort: 4-6 hours","status":"open","priority":1,"issue_type":"chore","created_at":"2025-10-26T21:21:10.90688+01:00","updated_at":"2025-10-26T21:21:10.90688+01:00","source_repo":".","labels":["maintainability","testing"]}
{"id":"scotty-32","content_hash":"7f553c32ed534b573e1a3d5011525f552e411bf8fac9cc8b99b145f9b1d1bd7b","title":"Upgrade ts-rs from 10.0 to 11.0","description":"ts-rs has a major version update available (10.0 → 11.0) that should be evaluated and applied. This affects TypeScript type generation.","design":"Location: scotty-types/Cargo.toml:21\n\nCurrent: ts-rs = { version = \"10.0\", features = [\"chrono-impl\", \"uuid-impl\"] }\nTarget: ts-rs = { version = \"11.0\", features = [\"chrono-impl\", \"uuid-impl\"] }\n\nSteps:\n1. Review ts-rs 11.0 changelog for breaking changes\n2. Update version in scotty-types/Cargo.toml\n3. Run TypeScript generation and verify output\n4. Test that generated TypeScript types are compatible with frontend\n5. Update any code that uses ts-rs macros if needed\n\nImpact: May change generated TypeScript types\nEffort: 2-4 hours","status":"closed","priority":3,"issue_type":"chore","assignee":"claude","created_at":"2025-10-26T22:07:52.621782+01:00","updated_at":"2025-10-26T22:14:26.407903+01:00","closed_at":"2025-10-26T22:14:26.407903+01:00","source_repo":".","labels":["dependencies","typescript"]}
{"id":"scotty-33","content_hash":"9f9e2857e1108f34c10da42ed6b042d2fdc8a3b1bbe2d0b03222f397b0fe359f","title":"Upgrade oauth2 from 4.4 to 5.0","description":"oauth2 crate has a major version update available (4.4 → 5.0). This affects OAuth2 authentication flow in the API.","design":"Location: scotty/Cargo.toml:61\n\nCurrent: oauth2 = \"4.4\"\nTarget: oauth2 = \"5.0\"\n\nSteps:\n1. Review oauth2 5.0 changelog and migration guide\n2. Identify breaking changes in API\n3. Update version in scotty/Cargo.toml\n4. Update OAuth2 implementation code to match new API\n5. Test OAuth2 authentication flows thoroughly\n6. Verify token generation and validation still works\n\nImpact: May require changes to OAuth2 authentication implementation\nEffort: 3-5 hours","status":"open","priority":3,"issue_type":"chore","created_at":"2025-10-26T22:08:00.856298+01:00","updated_at":"2025-10-26T22:08:00.856298+01:00","source_repo":".","labels":["dependencies","oauth","security"]}
{"id":"scotty-34","content_hash":"706ef74c45fbfad54aac2850465ddc2961db7b723ee3e4c3009c3d9de7661286","title":"Upgrade rustls ecosystem from 0.21 to 0.23","description":"rustls, tokio-rustls, and hyper-rustls have major version updates available (0.21 → 0.23, 0.24 → 0.26, 0.24 → 0.27). These need coordinated updates for TLS support.","design":"Current versions (transitive dependencies):\n- rustls: 0.21.12 → 0.23.34\n- tokio-rustls: 0.24.1 → 0.26.4  \n- hyper-rustls: 0.24.2 → 0.27.7\n\nThese are currently pulled in transitively through reqwest and other dependencies.\n\nSteps:\n1. Review rustls 0.23 changelog for breaking changes\n2. Check if reqwest needs update to support rustls 0.23\n3. Update any direct dependencies on rustls/tokio-rustls\n4. Ensure all TLS connections still work properly\n5. Test HTTPS endpoints and WebSocket over TLS\n6. Verify certificate validation still works\n\nImpact: TLS/SSL implementation changes, better security and performance\nEffort: 4-6 hours\n\nNote: This may require updating other HTTP-related crates in coordination.","status":"open","priority":3,"issue_type":"chore","created_at":"2025-10-26T22:08:11.918721+01:00","updated_at":"2025-10-26T22:08:11.918721+01:00","source_repo":".","labels":["dependencies","security","tls"]}
{"id":"scotty-35","content_hash":"2e6bba183d1f5ad638974870d0814ef139ca59a649a2d156fa9e2f253e4b2b29","title":"Upgrade http/hyper ecosystem to v1.x","description":"The http and hyper crates have major version updates (http 0.2 → 1.3, hyper 0.14 → 1.7, http-body 0.4 → 1.0). This is a coordinated ecosystem upgrade.","design":"Current versions (transitive dependencies):\n- http: 0.2.12 → 1.3.1\n- http-body: 0.4.6 → 1.0.1\n- hyper: 0.14.32 → 1.7.0\n- h2: 0.3.27 → 0.4.12\n\nThese are foundational HTTP crates used by axum, reqwest, and other dependencies.\n\nSteps:\n1. Review hyper 1.0 migration guide and breaking changes\n2. Check if current versions of axum/reqwest support hyper 1.x\n3. May need to update axum, reqwest, tower-http in coordination\n4. Update any direct usage of http/hyper types in code\n5. Test all HTTP endpoints (REST API, WebSocket, etc.)\n6. Verify middleware and error handling still works\n7. Run full integration test suite\n\nImpact: Major HTTP stack upgrade, affects all network communication\nEffort: 6-10 hours\n\nNote: This is a significant upgrade that touches the core HTTP stack. Should be done carefully with comprehensive testing. May need to wait for ecosystem crates to fully support hyper 1.x.","status":"open","priority":3,"issue_type":"chore","created_at":"2025-10-26T22:08:24.871193+01:00","updated_at":"2025-10-26T22:08:24.871193+01:00","source_repo":".","labels":["dependencies","http","infrastructure"]}
{"id":"scotty-36","content_hash":"3bc7c31d9de472a9fb2407e51eba67450f7155884e898f2ada9d1671c05e8da8","title":"Fix hardcoded localhost in OAuth callback URL","description":"The OAuth callback URL is hardcoded to use localhost, which breaks OAuth flows when the server is accessed via different hostnames.","design":"Location: scotty/src/oauth/handlers.rs:456-459\n\nCurrent code hardcodes localhost:\n```rust\nformat!(\n    \"http://localhost:21342/oauth/callback?session_id={}\",\n    oauth_session_id\n)\n```\n\nRecommendation: Add a `frontend_base_url` configuration option to allow dynamic callback URL construction:\n- Extract from request Host header\n- Fall back to configured base URL\n- Support both HTTP and HTTPS schemes\n\nImpact: OAuth web flows fail when scotty is accessed through production domains","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-27T11:42:29.94207+01:00","updated_at":"2025-10-27T15:02:23.208743+01:00","closed_at":"2025-10-27T15:02:23.208743+01:00","source_repo":".","labels":["oauth","production-blocker","security"]}
{"id":"scotty-37","content_hash":"5773202ffd6fb3a4c313cfa8de9484852ca63400de0fe9fd2c8e929eb79e7b2c","title":"Implement session cleanup for expired OAuth sessions","description":"OAuth session storage (DeviceFlowStore, WebFlowStore, OAuthSessionStore) accumulates expired sessions without cleanup, leading to unbounded memory growth.","design":"Impact:\n- Memory Leak: Server memory consumption grows indefinitely\n- DoS Vector: Attackers can exhaust server memory by creating sessions\n- Production Risk: Requires server restarts to reclaim memory\n\nCurrent: All three session stores use Arc\u003cMutex\u003cHashMap\u003cString, Session\u003e\u003e\u003e without expiration cleanup.\n\nRecommendation: Implement periodic cleanup task:\n1. Add background task using clokwerk scheduler (already in workspace dependencies)\n2. Scan sessions every N minutes\n3. Remove entries where SystemTime::now() \u003e expires_at\n4. Consider using a TTL cache library (ttl_cache, moka)","status":"closed","priority":1,"issue_type":"bug","assignee":"claude","created_at":"2025-10-27T11:42:30.048154+01:00","updated_at":"2025-10-27T15:28:59.581236+01:00","closed_at":"2025-10-27T15:28:59.581236+01:00","source_repo":".","labels":["memory-leak","oauth","security"]}
{"id":"scotty-38","content_hash":"7f5cbd276240efdd0aa6f92147fe31c47a0db0c6f18766bb55b2d7a773641d61","title":"Protect PKCE verifier with secrecy wrapper","description":"The PKCE verifier in WebFlowSession is stored as a plain String, allowing it to be logged, dumped in stack traces, or accidentally exposed.","design":"Location: scotty/src/oauth/mod.rs:40-48\n\nCurrent code stores PKCE verifier as plain String. This may appear in logs or error messages.\n\nRecommendation: Use the secrecy crate (already in workspace dependencies):\n```rust\nuse scotty_core::utils::secret::MaskedSecret;\n\npub struct WebFlowSession {\n    pub csrf_token: String,\n    pub pkce_verifier: MaskedSecret\u003cString\u003e,  // Protected\n    pub redirect_url: String,\n    pub frontend_callback_url: Option\u003cString\u003e,\n    pub expires_at: SystemTime,\n}\n```\n\nThe project already has MaskedSecret wrapper in scotty-core/src/utils/secret.rs.","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T11:42:30.152917+01:00","updated_at":"2025-10-27T11:42:30.152917+01:00","source_repo":".","labels":["oauth","security"]}
{"id":"scotty-39","content_hash":"9a07a2d508359e340d8a2829d5c633ae907fccbb10f84725c1484197be6da25e","title":"Use constant-time comparison for bearer token validation","description":"Bearer token comparison uses standard equality operator, making it vulnerable to timing attacks.","design":"Location: scotty/src/api/auth_core.rs:173-182\n\nCurrent code:\n```rust\nfn find_token_identifier(shared_app_state: \u0026SharedAppState, token: \u0026str) -\u003e Option\u003cString\u003e {\n    for (identifier, configured_token) in \u0026shared_app_state.settings.api.bearer_tokens {\n        if configured_token == token {  // NOT constant-time!\n            return Some(identifier.clone());\n        }\n    }\n    None\n}\n```\n\nVulnerability: Standard string comparison short-circuits on first mismatch, allowing attackers to reconstruct valid bearer tokens through timing analysis.\n\nRecommendation: Use constant-time comparison from subtle crate:\n```rust\nuse subtle::ConstantTimeEq;\n\nif token.as_bytes().ct_eq(configured_token.as_bytes()).into() {\n    return Some(identifier.clone());\n}\n```\n\nAdd subtle to Cargo.toml: `subtle = \"2.5\"`","notes":"PR #524 updated with complete fix:\n\nInitial commit (29845ae):\n- Fixed timing attack in auth_core.rs find_token_identifier()\n- Added subtle crate v2.6 for constant-time comparison\n\nSecond commit (c3328f1):\n- Fixed timing attack in login.rs login_handler()  \n- Applied constant-time comparison to bearer token login\n- Addresses PR review feedback\n\nAll token comparison points now use constant-time operations.\nAll 184 tests passing (110 scotty + 51 scotty-core + 20 scotty-types + 3 scottyctl)\n\nBranch: fix/scotty-39-constant-time-token-comparison\nPR: https://github.com/factorial-io/scotty/pull/524","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-27T11:42:30.260247+01:00","updated_at":"2025-11-05T09:52:42.788147+01:00","closed_at":"2025-11-05T09:52:42.788153+01:00","source_repo":".","labels":["security","vulnerability"]}
{"id":"scotty-4","content_hash":"c6b2d864cf336e8adb97283aa25f82d16a827ea8e23f54249bba6976176373b5","title":"Frontend interactive shell UI with xterm.js","description":"Add interactive shell terminal to web frontend using xterm.js. Backend ShellService is complete with WebSocket support, but frontend has no shell UI.","design":"- Integrate xterm.js for terminal emulation\n- WebSocket handlers for ShellSession* messages\n- TTY resize support on window resize\n- Copy/paste support\n- Terminal settings (font size, theme)\n- Shell session management UI (list, create, terminate)\n- Session timeout indicator","acceptance_criteria":"- Can open interactive shell to any service from web UI\n- Terminal emulation works correctly (colors, escape sequences)\n- Copy/paste functional\n- Terminal resizes properly\n- Session list shows active shells\n- Clean session termination\n- Security: requires Shell permission","status":"open","priority":2,"issue_type":"feature","created_at":"2025-10-25T00:58:22.023108+02:00","updated_at":"2025-10-25T00:58:22.023108+02:00","source_repo":".","dependencies":[{"issue_id":"scotty-4","depends_on_id":"scotty-1","type":"parent-child","created_at":"2025-10-25T00:58:32.576268+02:00","created_by":"daemon"},{"issue_id":"scotty-4","depends_on_id":"scotty-3","type":"related","created_at":"2025-10-25T00:58:39.410575+02:00","created_by":"daemon"}]}
{"id":"scotty-40","content_hash":"784a89cbe488480933a09f46e563d2b0f5a1b401e119c2d5096c06fc5911d2ea","title":"Add rate limiting to OAuth endpoints","description":"OAuth endpoints are publicly accessible without rate limiting, allowing DoS attacks and credential stuffing.","design":"Vulnerable Endpoints (scotty/src/api/router.rs:415-419):\n- POST /oauth/device\n- POST /oauth/device/token  \n- GET /oauth/authorize\n- GET /api/oauth/callback\n- POST /oauth/exchange\n\nAttack Scenarios:\n1. Credential Stuffing: Unlimited token validation attempts\n2. Session Exhaustion: Create thousands of sessions (combined with scotty-37 memory leak)\n3. Resource Exhaustion: Flood OIDC validation endpoint\n4. Enumeration: Discover valid session IDs through brute force\n\nRecommendation: Implement rate limiting using tower-governor middleware:\n```rust\nuse tower_governor::{governor::GovernorConfigBuilder, GovernorLayer};\n\nlet public_limiter = GovernorConfigBuilder::default()\n    .per_millisecond(100)  // 10 requests per second\n    .burst_size(20)\n    .finish()\n    .unwrap();\n```\n\nAdd dependency: `tower-governor = \"0.4\"`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-27T11:42:30.368145+01:00","updated_at":"2025-11-05T09:52:42.788825+01:00","closed_at":"2025-11-05T09:52:42.788827+01:00","source_repo":".","labels":["dos-prevention","oauth","security"]}
{"id":"scotty-41","content_hash":"58756e7c893fda682e360c50df77c79ff274c0526d0cfe7e0a4576ac4a4fdb60","title":"Add OAuth metrics for monitoring","description":"OAuth flows lack observability metrics, making it difficult to monitor authentication health, detect attack patterns, track session lifecycle, and debug production issues.","design":"Add OAuth-specific metrics to scotty/src/metrics/instruments.rs:\n\n```rust\n// OAuth flow metrics\npub oauth_device_flows_active: Gauge\u003ci64\u003e,\npub oauth_device_flows_total: Counter\u003cu64\u003e,\npub oauth_web_flows_active: Gauge\u003ci64\u003e,\npub oauth_web_flows_total: Counter\u003cu64\u003e,\npub oauth_flow_duration: Histogram\u003cf64\u003e,\npub oauth_flow_failures: Counter\u003cu64\u003e,\n\n// Token metrics\npub oauth_token_validations_total: Counter\u003cu64\u003e,\npub oauth_token_validation_duration: Histogram\u003cf64\u003e,\npub oauth_token_validation_failures: Counter\u003cu64\u003e,\npub oauth_active_sessions: Gauge\u003ci64\u003e,\npub oauth_expired_sessions_cleaned: Counter\u003cu64\u003e,\n```\n\nInstrumentation Points:\n1. start_device_flow() - increment device flows total/active\n2. start_authorization_flow() - increment web flows total/active\n3. validate_oidc_token() - track validation count and duration\n4. Session cleanup task - track expired session removal\n5. exchange_session_for_token() - track successful exchanges\n\nRelated to scotty-37 (session cleanup) and scotty-42 (cache metrics)","status":"closed","priority":2,"issue_type":"task","assignee":"claude","created_at":"2025-10-27T11:42:30.477735+01:00","updated_at":"2025-10-27T15:36:55.30953+01:00","closed_at":"2025-10-27T15:36:55.30953+01:00","source_repo":".","labels":["metrics","oauth","observability"],"dependencies":[{"issue_id":"scotty-41","depends_on_id":"scotty-37","type":"blocks","created_at":"2025-10-27T11:42:30.478666+01:00","created_by":"daemon"}]}
{"id":"scotty-42","content_hash":"7e14b974a83239b4af0f60e71247913211196ea18c0cb7c36d1d5ae20078618f","title":"Implement token caching for OIDC validation","description":"OIDC token validation makes an HTTP request to /oauth/userinfo on every API request, causing high latency, increased load on OIDC provider, potential rate limiting, and poor API performance.","design":"Location: scotty/src/oauth/device_flow.rs:221-256\n\nCurrent code makes HTTP call on EVERY validation. \n\nRecommendation: Implement in-memory token cache with TTL using moka or mini-moka crate for built-in TTL and LRU eviction.\n\n⚠️ CRITICAL: Must implement cache entry cleanup to prevent memory leaks:\n1. Background task to remove expired entries (every 5-10 minutes)\n2. Max cache size with LRU eviction policy\n3. Manual invalidation on token revocation events\n\nPerformance Impact:\n- Reduces validation latency from ~100-500ms to \u003c1ms (cache hit)\n- Reduces OIDC provider load by 95%+\n- Improves API response times significantly\n\nRelated: scotty-41 for cache hit/miss metrics","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T11:42:30.587922+01:00","updated_at":"2025-10-27T11:42:30.587922+01:00","source_repo":".","labels":["caching","oauth","performance"]}
{"id":"scotty-43","content_hash":"7a259100455f392c6668fc7279cc96a5a13d50f0ccc4e136c5d32813e6323127","title":"Prevent concurrent tasks for the same app","description":"Currently you can run multiple tasks for the same app at the same time, this should be prevented. On the other hand we need the possibility to cancel a running task to enable the UI again. The concurrent task prevention should be handled ideally by the backend.","design":"The backend should track running tasks per app and reject new task requests if a task is already running for that app.\n\nImplementation considerations:\n1. TaskManager should track which app each task belongs to\n2. Add endpoint to check if app has running tasks\n3. Add task cancellation endpoint\n4. Frontend UI should:\n   - Disable action buttons when task is running\n   - Show cancel button for running tasks\n   - Re-enable UI when task completes/cancelled\n\nLocation: scotty/src/tasks/manager.rs","status":"open","priority":2,"issue_type":"bug","created_at":"2025-10-27T11:43:29.205844+01:00","updated_at":"2025-10-27T11:43:29.205844+01:00","source_repo":".","labels":["tasks","ux"]}
{"id":"scotty-44","content_hash":"4dd6944a664dc1c4bd83f30a40bb32bf27e91bc9a96d23954b331305d9028a00","title":"State machine handler errors don't bubble up to tasks","description":"If a state_machine_handler errors out, the error does not bubble up to the task, keeping the task running forever.","design":"## Root Cause Analysis\n\n### Issue #1: State Machine spawn() Returns JoinHandle\u003c()\u003e\nLocation: scotty/src/state_machine.rs:92-108\n\nThe spawn() method catches errors internally and returns JoinHandle\u003c()\u003e:\n- Return type is JoinHandle\u003c()\u003e, not JoinHandle\u003cResult\u003c(), E\u003e\u003e\n- Errors are only logged, not propagated\n- JoinHandle always completes successfully even when state machine fails\n\n### Issue #2: Top-Level Integration Discards Handle\nLocation: scotty/src/docker/helper.rs:44\n\nHandle is discarded with underscore prefix, function returns immediately without checking result.\n\n### Issue #3: Nested State Machines Lose Errors\nLocations: create_app.rs:44-45, destroy_app.rs:36-37\n\nNested state machines don't propagate errors to parent state machine.\n\n## Proposed Solution\n\n### Change spawn() to Return Result\n\nNew signature: JoinHandle\u003canyhow::Result\u003c()\u003e\u003e\n\nBenefits:\n- Explicit error propagation\n- Type system enforces error handling\n- Panic-safe with proper JoinError handling\n\n### Implementation Steps\n\n1. Update state_machine.rs spawn():\n   - Change return type to JoinHandle\u003canyhow::Result\u003c()\u003e\u003e\n   - Return result directly instead of catching errors\n   - Keep error logging for observability\n\n2. Update helper.rs run_sm():\n   - Handle Ok(Ok(())) - success\n   - Handle Ok(Err(e)) - error (already marked Failed by error handler)\n   - Handle Err(join_err) - panic (manually mark task Failed)\n\n3. Update nested state machines in create_app.rs and destroy_app.rs:\n   - Propagate errors from inner state machines to outer\n   - Convert panics to errors\n\n### Safety Net: Task Timeout (Phase 2)\n\nAdd timeout monitoring to catch any missed errors.\n\n### Files to Modify\n\n1. scotty/src/state_machine.rs - Change spawn() signature\n2. scotty/src/docker/helper.rs - Add error/panic handling\n3. scotty/src/docker/create_app.rs - Update nested SM\n4. scotty/src/docker/destroy_app.rs - Update nested SM\n5. scotty/src/tasks/manager.rs - Add timeout (Phase 2)\n6. Add comprehensive tests\n\n### Testing Strategy\n\n- Unit tests: handler failure, panic, nested errors\n- Integration tests: create app with failures, rebuild failures, timeout","notes":"Implementation complete with refactoring addressing review feedback.\n\nCommits:\n- ef543365: Core implementation (spawn returns Result)\n- 21dadba6: Beads metadata\n- 0c6012a2: Refactoring - extracted shared helper\n\nKey refactoring:\n- Added Context::complete_task() as single source of truth\n- TaskCompletionHandler and helper.rs both use shared helper\n- Ensures WebSocket broadcast always happens\n- Defensive and idempotent\n\nAll 291+ workspace tests passing.\nReady for merge.","status":"open","priority":1,"issue_type":"bug","created_at":"2025-10-27T11:43:29.276532+01:00","updated_at":"2025-11-05T09:52:42.789055+01:00","external_ref":"gh-547","source_repo":".","labels":["error-handling","state-machine","tasks"]}
{"id":"scotty-45","content_hash":"cc504c8fce28599af23f98c8a59ca128ddbd8f5e25f532e811fa014bb3bc42e0","title":"Fix hardcoded localhost in OAuth callback URL","description":"The OAuth callback URL is hardcoded to use localhost, which breaks OAuth flows when the server is accessed via different hostnames.","design":"Location: scotty/src/oauth/handlers.rs:456-459\n\nCurrent code hardcodes localhost:\n```rust\nformat!(\n    \"http://localhost:21342/oauth/callback?session_id={}\",\n    oauth_session_id\n)\n```\n\nRecommendation: Add a `frontend_base_url` configuration option to allow dynamic callback URL construction:\n- Extract from request Host header\n- Fall back to configured base URL\n- Support both HTTP and HTTPS schemes\n\nImpact: OAuth web flows fail when scotty is accessed through production domains","status":"open","priority":1,"issue_type":"bug","created_at":"2025-10-27T15:02:24.111221+01:00","updated_at":"2025-10-27T15:02:24.111221+01:00","source_repo":".","labels":["oauth","production-blocker","security"]}
{"id":"scotty-46","content_hash":"d5aeae50119c94b5ad09f2e4dc62c4230c3046513c3e2cd7f0c933af9464a28b","title":"Support bearer tokens alongside OAuth for service accounts","description":"Modify authentication middleware to allow bearer token authentication as a fallback when OAuth is enabled, enabling service accounts to use bearer tokens while users authenticate via OAuth.","design":"Modify the auth middleware in scotty/src/api/basic_auth.rs to support fallback authentication when in OAuth mode:\n1. When AuthMode::OAuth, first try OAuth validation via authorize_oauth_user_native\n2. If OAuth validation fails, fallback to bearer token validation via authorize_bearer_user\n3. This enables both OAuth tokens (for users) and bearer tokens (for service accounts) to work simultaneously\n4. No breaking changes - Bearer and Development modes remain unchanged","acceptance_criteria":"- OAuth tokens continue to validate successfully\n- Bearer tokens authenticate when OAuth validation fails\n- Bearer-only mode still works unchanged\n- Service accounts can authenticate with bearer tokens when OAuth is enabled\n- Authorization/RBAC works correctly for both token types\n- Tests cover OAuth priority and bearer fallback scenarios","status":"closed","priority":2,"issue_type":"feature","assignee":"claude","created_at":"2025-11-03T11:07:22.572676+01:00","updated_at":"2025-11-03T11:17:22.810051+01:00","closed_at":"2025-11-03T11:17:22.810051+01:00","source_repo":"."}
{"id":"scotty-47","content_hash":"5a4791ae6c60ff300541f5dd07e9ef34f266928fb293396c48f9d281a7e4adb8","title":"Clarify identifier vs token distinction in policy.yaml and documentation","description":"The RBAC policy file contains what appears to be token values as identifiers (e.g., 'identifier:test-bearer-token-123'), creating confusion about whether this is an identifier or actual token. This pattern could encourage developers to put token values in RBAC assignments, which is a security concern.","design":"1. Review config/casbin/policy.yaml and test configs\n2. Ensure identifiers are semantic names (e.g., 'admin', 'client-a') NOT token values\n3. Token values should ONLY exist in bearer_tokens configuration\n4. Add comments in policy.yaml explaining the identifier vs token distinction\n5. Update any test configs that conflate identifiers with token values\n6. Add documentation explaining this pattern","acceptance_criteria":"- policy.yaml uses semantic identifiers (admin, client-a) not token values\n- Comments in policy.yaml explain identifier naming\n- bearer_tokens config maps identifiers to actual token values\n- Documentation clearly explains the pattern\n- No token values appear in RBAC policy files","notes":"Implementation completed:\n\n**Security Fixes:**\n- ✅ Fixed Dockerfile to NOT copy config directory (was baking secrets into images!)\n- ✅ Now only copies safe files: casbin/model.conf and blueprints/\n- ✅ Fixed confusing identifier naming: test-bearer-token-123 → test-service\n\n**Documentation Added:**\n- ✅ Created config/README.md with comprehensive configuration guide\n- ✅ Created config/default.yaml.example (template without secrets)\n- ✅ Created config/casbin/policy.yaml.example (example RBAC with clear comments)\n- ✅ Added Docker deployment section to main README.md\n- ✅ Documented identifier vs token distinction extensively\n\n**Configuration Improvements:**\n- ✅ Updated .gitignore to exclude sensitive config files\n- ✅ Added comments to test configs explaining identifier pattern\n- ✅ Updated default.yaml bearer_tokens to match new semantic identifiers\n\n**Key Security Principles Documented:**\n1. Identifiers are NAMES in policy.yaml (e.g., \"admin\", \"ci-bot\")\n2. Token VALUES are secrets in environment variables\n3. Never commit secrets to git\n4. Docker images contain NO sensitive configs\n5. Mount config at runtime or use environment variables","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-03T11:22:43.858318+01:00","updated_at":"2025-11-03T15:44:57.105463+01:00","closed_at":"2025-11-03T15:44:57.105463+01:00","source_repo":".","dependencies":[{"issue_id":"scotty-47","depends_on_id":"scotty-46","type":"blocks","created_at":"2025-11-03T11:22:43.860319+01:00","created_by":"daemon"}]}
{"id":"scotty-48","content_hash":"fae7b67822295bd3042c9678355a28700ca296732a9baa863bcd144d9875ea1c","title":"Add documentation for hybrid OAuth + bearer token authentication","description":"Users need documentation explaining how to configure the API for hybrid authentication where OAuth is used for human users and bearer tokens for service accounts. Currently there's no user-facing documentation for this capability.","design":"Add documentation section explaining:\n1. The use case: OAuth for users + bearer tokens for service accounts\n2. Configuration example showing auth_mode=oauth with bearer_tokens\n3. How authentication fallback works (OAuth tried first, bearer second)\n4. RBAC configuration for service account identifiers\n5. Migration guide for existing OAuth deployments\n\nLocation: README.md or docs/authentication.md","acceptance_criteria":"- Documentation section exists explaining hybrid auth\n- Configuration example provided\n- Authentication flow explained\n- RBAC setup for service accounts documented\n- Migration guide included","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-03T11:22:43.917274+01:00","updated_at":"2025-11-03T17:17:54.680886+01:00","closed_at":"2025-11-03T17:17:54.680886+01:00","source_repo":".","dependencies":[{"issue_id":"scotty-48","depends_on_id":"scotty-46","type":"blocks","created_at":"2025-11-03T11:22:43.917783+01:00","created_by":"daemon"}]}
{"id":"scotty-49","content_hash":"59d8324418c0e19c49586f8886d2bb2ba38b29f242d8267a1afad1b5f97f01e3","title":"Optimize auth flow: check bearer tokens before OAuth","description":"Current implementation tries OAuth first (network call to OIDC provider) then falls back to bearer tokens. This adds unnecessary latency for service accounts that will always use bearer tokens. We should check if the token exists in configured bearer_tokens first (fast HashMap lookup), and only try OAuth if not found.","design":"Update scotty/src/api/basic_auth.rs OAuth mode logic:\n\nCurrent (slow for service accounts):\n1. Try OAuth (network call) → fail → try bearer token\n\nOptimized (fast for service accounts):\n1. Extract token from Authorization header\n2. Check if token exists in bearer_tokens config (use find_token_identifier)\n3. If found → authenticate as bearer token\n4. If not found → try OAuth validation\n\nImplementation:\n- Add helper function or inline check for bearer token existence\n- Reorder authentication attempts\n- Add log messages for which path was taken\n- Maintain constant-time comparison for security\n- Add tests verifying the optimization works","acceptance_criteria":"- Bearer tokens checked before OAuth (no network call for service accounts)\n- OAuth still works for non-bearer tokens\n- Log messages indicate which auth path was used\n- Tests verify bearer tokens bypass OAuth attempt\n- Performance improvement measurable (no OIDC provider latency for service accounts)\n- Security maintained (constant-time comparison)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-03T11:22:43.976607+01:00","updated_at":"2025-11-03T14:03:05.803754+01:00","closed_at":"2025-11-03T14:03:05.803754+01:00","source_repo":".","dependencies":[{"issue_id":"scotty-49","depends_on_id":"scotty-46","type":"blocks","created_at":"2025-11-03T11:22:43.97718+01:00","created_by":"daemon"}]}
{"id":"scotty-5","content_hash":"00e6f5cdca2d2108aa6da0b9712b43601ee54626e559eea5c435b8c391b50c39","title":"Enhanced monitoring and observability","description":"Add comprehensive monitoring for the unified output system. Basic logging exists but metrics and tracing are incomplete.","design":"Implementation using OpenTelemetry Collector + VictoriaMetrics architecture.\n\nArchitecture:\n- Scotty exports OTLP metrics to OTel Collector (port 4317)\n- OTel Collector routes traces to Jaeger, metrics to VictoriaMetrics\n- Grafana visualizes metrics from VictoriaMetrics\n- Total memory overhead: ~180-250 MB\n\nSee docs/research/otel-metrics-backend-evaluation.md for complete research and rationale.","acceptance_criteria":"- Prometheus metrics exported\n- Grafana dashboard created\n- Tracing spans for log/shell operations\n- Memory usage tracked\n- Error rates monitored","notes":"Chosen solution: OTel Collector + VictoriaMetrics for lightweight, OpenTelemetry-native metrics collection. Integrates with existing Jaeger setup.","status":"open","priority":3,"issue_type":"task","created_at":"2025-10-25T00:58:22.135422+02:00","updated_at":"2025-10-25T01:28:15.468691+02:00","source_repo":".","dependencies":[{"issue_id":"scotty-5","depends_on_id":"scotty-1","type":"parent-child","created_at":"2025-10-25T00:58:32.652182+02:00","created_by":"daemon"}]}
{"id":"scotty-50","content_hash":"99f66fd6e62e0becf24f2655e59a8650229b6191ed136ec7dfe2b84e2b020ac1","title":"Add test for OAuth vs bearer token authentication precedence","description":"Add test case to verify that when a token could theoretically be valid for both OAuth and bearer token auth, OAuth takes precedence. This ensures the authentication priority is well-tested and documented.","design":"Add test in scotty/src/api/bearer_auth_tests.rs:\n1. Test name: test_oauth_vs_bearer_precedence\n2. Set up scenario where same token value could match both\n3. Verify OAuth validation is attempted first\n4. Ensure bearer token fallback only happens after OAuth fails\n5. Document the precedence behavior in test comments","acceptance_criteria":"- Test added verifying OAuth takes precedence\n- Test passes\n- Test comments explain precedence behavior\n- Coverage of authentication priority path","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-03T11:22:44.036978+01:00","updated_at":"2025-11-03T11:22:44.036978+01:00","source_repo":".","dependencies":[{"issue_id":"scotty-50","depends_on_id":"scotty-46","type":"blocks","created_at":"2025-11-03T11:22:44.037547+01:00","created_by":"daemon"}]}
{"id":"scotty-6","content_hash":"ae287e0336e181c76c79769d12cd540a75c5d8f47e46678bc7fc510371cb44d5","title":"End-user documentation for unified output system","description":"Write comprehensive end-user documentation for the logs and shell features. Technical PRD exists but user-facing docs are missing.","design":"- User guide for app:logs command with examples\n- User guide for app:shell command (once CLI implemented)\n- Web UI documentation for log viewer\n- Web UI documentation for shell access\n- Security best practices for shell access\n- Troubleshooting guide\n- Add to main documentation site","acceptance_criteria":"- app:logs documented with all options\n- app:shell documented (when available)\n- Screenshots of web UI features\n- Security guidelines clear\n- Common issues documented\n- Published to docs site","status":"open","priority":3,"issue_type":"task","created_at":"2025-10-25T00:58:22.241151+02:00","updated_at":"2025-10-25T00:58:22.241151+02:00","source_repo":".","dependencies":[{"issue_id":"scotty-6","depends_on_id":"scotty-1","type":"parent-child","created_at":"2025-10-25T00:58:32.723437+02:00","created_by":"daemon"},{"issue_id":"scotty-6","depends_on_id":"scotty-2","type":"related","created_at":"2025-10-25T00:58:39.470922+02:00","created_by":"daemon"}]}
{"id":"scotty-7","content_hash":"92a279ed85a9c28df1270f2e882924938341b61fcb1815032a6d5c3d7dfd53b6","title":"Add OpenTelemetry metrics dependencies to workspace","description":"Add metrics feature to opentelemetry and opentelemetry-otlp crates in workspace Cargo.toml. Enable metrics support in opentelemetry_sdk.","design":"Update workspace Cargo.toml:\n- opentelemetry: Add \"metrics\" feature\n- opentelemetry_sdk: Add \"metrics\" to features array\n- opentelemetry-otlp: Add \"metrics\" feature","acceptance_criteria":"- Cargo.toml updated with metrics features\n- cargo check passes\n- No breaking changes to existing trace functionality","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-25T01:28:15.598548+02:00","updated_at":"2025-10-25T01:32:41.399679+02:00","closed_at":"2025-10-25T01:32:41.399679+02:00","source_repo":".","dependencies":[{"issue_id":"scotty-7","depends_on_id":"scotty-5","type":"parent-child","created_at":"2025-10-25T01:28:29.940257+02:00","created_by":"daemon"}]}
{"id":"scotty-8","content_hash":"cff816ccbe2be0b5813e4531767b91496a23a9e80da86112af5a684534c1a464","title":"Create metrics module with ScottyMetrics struct","description":"Create scotty/src/metrics/mod.rs with ScottyMetrics struct containing all metric instruments (counters, gauges, histograms) for unified output system monitoring.","design":"Create metrics module with:\n- ScottyMetrics struct with all instruments\n- init_metrics() function to set up OTLP exporter\n- Metrics for: log streams, shell sessions, WebSocket, tasks, system health\n- Uses opentelemetry::metrics API (Counter, Gauge, Histogram)","acceptance_criteria":"- metrics/mod.rs created and compiles\n- ScottyMetrics struct has all planned metrics\n- init_metrics() successfully initializes MeterProvider\n- Metrics can be recorded without panics","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-25T01:28:15.721881+02:00","updated_at":"2025-10-25T01:50:03.687196+02:00","closed_at":"2025-10-25T01:50:03.687196+02:00","source_repo":".","dependencies":[{"issue_id":"scotty-8","depends_on_id":"scotty-5","type":"parent-child","created_at":"2025-10-25T01:28:30.027423+02:00","created_by":"daemon"},{"issue_id":"scotty-8","depends_on_id":"scotty-7","type":"blocks","created_at":"2025-10-25T01:28:42.019675+02:00","created_by":"daemon"}]}
{"id":"scotty-9","content_hash":"402f308c9d97fed435f2ce1ddf676bb7fd82dd9d685271fbcdb0e88f5a78a46a","title":"Instrument log streaming service with metrics","description":"Add metrics recording to LogStreamingService for stream counts, durations, errors, and bytes transferred.","design":"Instrument LogStreamingService:\n- Increment log_streams_active on stream start\n- Increment log_streams_total counter\n- Record log_stream_duration on completion\n- Track log_lines_received and log_stream_bytes\n- Increment log_stream_errors on failures","acceptance_criteria":"- Metrics recorded at stream start/end\n- Duration measured accurately\n- Error cases increment error counter\n- No performance degradation","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-25T01:28:15.847014+02:00","updated_at":"2025-10-25T01:57:04.063722+02:00","closed_at":"2025-10-25T01:57:04.063722+02:00","source_repo":".","dependencies":[{"issue_id":"scotty-9","depends_on_id":"scotty-5","type":"parent-child","created_at":"2025-10-25T01:28:30.109241+02:00","created_by":"daemon"},{"issue_id":"scotty-9","depends_on_id":"scotty-8","type":"blocks","created_at":"2025-10-25T01:28:42.089191+02:00","created_by":"daemon"}]}
