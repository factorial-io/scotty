#!/bin/sh
#
# Pre-push hook for scotty
# Ensures code quality before pushing to remote
#

set -e

echo "Running pre-push checks..."
echo ""

# 1. Check code formatting first (fastest check)
echo "ğŸ“ Checking Rust code formatting..."
cargo fmt -- --check
echo "âœ… Rust formatting OK"
echo ""

# 2. Run Clippy linter (all targets including tests, benches, examples)
echo "ğŸ” Running Clippy linter..."
cargo clippy --all-targets -- -D warnings
echo "âœ… Clippy checks passed"
echo ""

# 3. Frontend checks (only if frontend files changed)
# Check if any frontend files are being pushed
if git diff --name-only @{upstream}..HEAD 2>/dev/null | grep -q "^frontend/" || \
   git diff --name-only HEAD 2>/dev/null | grep -q "^frontend/"; then

    echo "ğŸ”§ Generating TypeScript bindings..."
    cargo run --bin scotty-ts-generator
    echo "âœ… TypeScript bindings generated"
    echo ""

    echo "ğŸ¨ Linting frontend code..."
    cd frontend && bun run lint
    cd ..
    echo "âœ… Frontend linting passed"
    echo ""

    echo "ğŸ” Type-checking frontend code..."
    cd frontend && bun run check
    cd ..
    echo "âœ… Frontend type checking passed"
    echo ""
else
    echo "â­ï¸  Skipping frontend checks (no frontend changes detected)"
    echo ""
fi

# 4. Run Rust tests (slowest, run last)
echo "ğŸ§ª Running Rust tests..."
cargo test
echo "âœ… All tests passed"
echo ""

echo "ğŸ‰ All pre-push checks passed! Proceeding with push..."
